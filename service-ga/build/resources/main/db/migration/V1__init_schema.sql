CREATE TABLE LIBRO (
  LIBRO_ID       VARCHAR2(50) PRIMARY KEY,
  TITULO         VARCHAR2(200) NOT NULL,
  STOCK_SEDE_A   NUMBER(10)    DEFAULT 0,
  STOCK_SEDE_B   NUMBER(10)    DEFAULT 0
);

CREATE TABLE USUARIO (
  USUARIO_ID VARCHAR2(50) PRIMARY KEY,
  NOMBRE     VARCHAR2(120) NOT NULL
);

CREATE TABLE PRESTAMO (
  PRESTAMO_ID   NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  LIBRO_ID      VARCHAR2(50) NOT NULL REFERENCES LIBRO(LIBRO_ID),
  USUARIO_ID    VARCHAR2(50) NOT NULL REFERENCES USUARIO(USUARIO_ID),
  FECHA_INICIO  DATE DEFAULT SYSDATE,
  FECHA_ENTREGA DATE NOT NULL,
  RENOVACIONES  NUMBER(2)    DEFAULT 0,
  ESTADO        VARCHAR2(20) CHECK (ESTADO IN ('ACTIVO','DEV'))
);

-- Idempotencia (aplicación única por key)
CREATE TABLE GA_IDEMPOTENCY (
  IDEMPOTENCY_KEY  VARCHAR2(64) PRIMARY KEY,
  CREATED_AT       DATE DEFAULT SYSDATE,
  OP_SUMMARY       VARCHAR2(200)
);

-- Outbox para replicación
CREATE TABLE GA_OUTBOX (
  ID           NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  EVENT_TYPE   VARCHAR2(50) NOT NULL,
  PAYLOAD      CLOB NOT NULL,
  CREATED_AT   DATE DEFAULT SYSDATE,
  PROCESSED_AT DATE
);
CREATE INDEX IX_OUTBOX_CREATED ON GA_OUTBOX (CREATED_AT);
